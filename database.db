DROP DATABASE IF EXISTS `sistema_TCC(2)`;
CREATE DATABASE `sistema_TCC(2)` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE `sistema_TCC(2)`;

CREATE TABLE `usuario` (
  `id` int NOT NULL AUTO_INCREMENT,
  `nome` varchar(255) NOT NULL,
  `email` varchar(255) NOT NULL,
  `senha_hash` text NOT NULL,
  `perfil` varchar(50) DEFAULT NULL,
  `ativo` tinyint(1) NOT NULL DEFAULT '1',
  `criado_em` timestamp DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `produto` (
  `id` int NOT NULL AUTO_INCREMENT,
  `linha` varchar(255) NOT NULL,
  `formato` varchar(255) NOT NULL,
  `descricao` text,
  `imagem_url` text,
  `ativo` tinyint(1) NOT NULL DEFAULT '1',
  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `variante` (
  `id` int NOT NULL AUTO_INCREMENT,
  `produto_id` int NOT NULL,
  `altura_cm` decimal(7,2) DEFAULT NULL,
  `largura_cm` decimal(7,2) DEFAULT NULL,
  `cor` varchar(100) DEFAULT NULL,
  `led_direto` tinyint(1) NOT NULL DEFAULT '0',
  `led_indireto` tinyint(1) NOT NULL DEFAULT '0',
  `moldura` varchar(100) DEFAULT NULL,
  `sku` varchar(100) NOT NULL,
  `preco_base` decimal(12,2) NOT NULL,
  `ativo` tinyint(1) NOT NULL DEFAULT '1',
  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `sku` (`sku`),
  CONSTRAINT `variante_ibfk_1` FOREIGN KEY (`produto_id`) REFERENCES `produto` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `estoque` (
  `id` int NOT NULL AUTO_INCREMENT,
  `variante_id` int NOT NULL,
  `quantidade` int NOT NULL DEFAULT '0',
  `minimo` int NOT NULL DEFAULT '0',
  `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `variante_id` (`variante_id`),
  CONSTRAINT `estoque_ibfk_1` FOREIGN KEY (`variante_id`) REFERENCES `variante` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `pedido` (
  `id` int NOT NULL AUTO_INCREMENT,
  `cliente_nome` varchar(255) NOT NULL,
  `cliente_contato` varchar(255) DEFAULT NULL,
  `status` enum('criado','aprovado','em_producao','em_logistica','entregue','finalizado') DEFAULT 'criado',
  `total` decimal(14,2) NOT NULL DEFAULT '0.00',
  `criado_por` int NOT NULL,
  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  CONSTRAINT `pedido_ibfk_1` FOREIGN KEY (`criado_por`) REFERENCES `usuario` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `item_pedido` (
  `id` int NOT NULL AUTO_INCREMENT,
  `pedido_id` int NOT NULL,
  `variante_id` int NOT NULL,
  `quantidade` int NOT NULL,
  `preco_unit` decimal(12,2) NOT NULL,
  `valor_total` decimal(12,2) NOT NULL,
  `observacoes` text,
  PRIMARY KEY (`id`),
  CONSTRAINT `item_pedido_ibfk_1` FOREIGN KEY (`pedido_id`) REFERENCES `pedido` (`id`) ON DELETE CASCADE,
  CONSTRAINT `item_pedido_ibfk_2` FOREIGN KEY (`variante_id`) REFERENCES `variante` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `op_producao` (
  `id` int NOT NULL AUTO_INCREMENT,
  `item_pedido_id` int NOT NULL,
  `status` enum('aberto','em_andamento','concluido') DEFAULT 'aberto',
  `data_abertura` timestamp DEFAULT CURRENT_TIMESTAMP,
  `data_conclusao` timestamp DEFAULT NULL,
  `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `item_pedido_id` (`item_pedido_id`),
  CONSTRAINT `op_producao_ibfk_1` FOREIGN KEY (`item_pedido_id`) REFERENCES `item_pedido` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `fase_op` (
  `id` int NOT NULL AUTO_INCREMENT,
  `op_id` int NOT NULL,
  `nome` varchar(255) NOT NULL,
  `status` enum('pendente','em_execucao','concluida') DEFAULT 'pendente',
  `inicio` timestamp NULL DEFAULT NULL,
  `fim` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  CONSTRAINT `fase_op_ibfk_1` FOREIGN KEY (`op_id`) REFERENCES `op_producao` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `movimento_estoque` (
  `id` int NOT NULL AUTO_INCREMENT,
  `estoque_id` int NOT NULL,
  `usuario_id` int DEFAULT NULL,
  `quantidade` int NOT NULL,
  `motivo` varchar(255) NOT NULL,
  `data` timestamp DEFAULT CURRENT_TIMESTAMP,
  `observacao` text,
  PRIMARY KEY (`id`),
  CONSTRAINT `movimento_estoque_ibfk_1` FOREIGN KEY (`estoque_id`) REFERENCES `estoque` (`id`),
  CONSTRAINT `movimento_estoque_ibfk_2` FOREIGN KEY (`usuario_id`) REFERENCES `usuario` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `agendamento_entrega` (
  `id` int NOT NULL AUTO_INCREMENT,
  `pedido_id` int NOT NULL,
  `endereco` text NOT NULL,
  `data_prevista` timestamp NOT NULL,
  `motorista` varchar(255) DEFAULT NULL,
  `veiculo` varchar(255) DEFAULT NULL,
  `observacao` text,
  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `pedido_id` (`pedido_id`),
  CONSTRAINT `agendamento_entrega_ibfk_1` FOREIGN KEY (`pedido_id`) REFERENCES `pedido` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `anexo_pedido` (
  `id` int NOT NULL AUTO_INCREMENT,
  `pedido_id` int NOT NULL,
  `arquivo_url` text NOT NULL,
  `tipo` varchar(100) DEFAULT NULL,
  `enviado_em` timestamp DEFAULT CURRENT_TIMESTAMP,
  `enviado_por` int DEFAULT NULL,
  PRIMARY KEY (`id`),
  CONSTRAINT `anexo_pedido_ibfk_1` FOREIGN KEY (`pedido_id`) REFERENCES `pedido` (`id`) ON DELETE CASCADE,
  CONSTRAINT `anexo_pedido_ibfk_2` FOREIGN KEY (`enviado_por`) REFERENCES `usuario` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `tracking` (
  `id` int NOT NULL AUTO_INCREMENT,
  `pedido_id` int NOT NULL,
  `evento` enum('roteirizado','em_rota','entregue') NOT NULL,
  `detalhes` text,
  `data` timestamp DEFAULT CURRENT_TIMESTAMP,
  `foto_url` text,
  PRIMARY KEY (`id`),
  CONSTRAINT `tracking_ibfk_1` FOREIGN KEY (`pedido_id`) REFERENCES `pedido` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `sessao` (
  `id` int NOT NULL AUTO_INCREMENT,
  `usuario_id` int NOT NULL,
  `ip` varchar(45) DEFAULT NULL,
  `user_agent` text,
  `criado_em` timestamp DEFAULT CURRENT_TIMESTAMP,
  `expiracao` timestamp DEFAULT NULL,
  PRIMARY KEY (`id`),
  CONSTRAINT `sessao_ibfk_1` FOREIGN KEY (`usuario_id`) REFERENCES `usuario` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE VIEW `vw_catalogo` AS 
SELECT p.id AS produto_id, v.id AS variante_id, p.linha AS linha, p.formato AS formato, 
v.altura_cm, v.largura_cm, v.cor, v.led_direto, v.led_indireto, v.moldura, v.sku, v.preco_base,
e.quantidade AS estoque
FROM produto p
JOIN variante v ON v.produto_id = p.id
LEFT JOIN estoque e ON e.variante_id = v.id
WHERE p.ativo = 1 AND v.ativo = 1;

DELIMITER //

CREATE TRIGGER `tr_item_pedido_valor_total` 
BEFORE INSERT ON `item_pedido`
FOR EACH ROW
BEGIN
  SET NEW.valor_total = NEW.preco_unit * NEW.quantidade;
END//

CREATE TRIGGER `tr_item_pedido_valor_total_update` 
BEFORE UPDATE ON `item_pedido`
FOR EACH ROW
BEGIN
  SET NEW.valor_total = NEW.preco_unit * NEW.quantidade;
END//

CREATE TRIGGER `tr_movimento_estoque` 
AFTER INSERT ON `movimento_estoque`
FOR EACH ROW
BEGIN
  UPDATE estoque
  SET quantidade = quantidade + NEW.quantidade
  WHERE id = NEW.estoque_id;
END//

DELIMITER ;
